"use strict";var reader=function(e,o){function r(){var o=e(document).height(),r=e(window).height(),t=e(window).scrollTop();return t/(o-r)*100}function t(o){reader.documentScrollPercent=o;var r=e(document).height(),t=e(window).height(),a=o/100*(r-t);e(window).scrollTop(a),c.readerViewModel.documentScrollPercent(o)}function a(){return window.getSelection().toString()}function n(){var r=c.calculateDocumentReadPosition(),t=c.getSelection()||"[ untitled ]";return t.length>30&&(t=t.slice(0,(t.indexOf(" ",30)>-1?t.indexOf(" ",30):t.lastIndexOf(" ")>-1?t.lastIndexOf(" "):30)+1)+"..."),o?(c.readerViewModel.addBookmark(reader.readerViewModel.bookmarks().length,r,t),EverReaderJS.Notify("Bookmark added")):e.ajax("/api/bookmarks/"+noteGuid,{method:"POST",data:{percentageRead:r,bookmarkTitle:t},success:function(e){c.readerViewModel.addBookmark(e.id,r,t),EverReaderJS.Notify("Bookmark added")},error:function(){}}),!1}function d(r,t){return o?(c.readerViewModel.deleteBookmark(t),EverReaderJS.Notify("Bookmark deleted")):e.ajax("/api/bookmarks/"+noteGuid,{method:"DELETE",data:{id:t},success:function(e){e.error?EverReaderJS.Notify("There was a problem deleting your bookmark","danger"):(c.readerViewModel.deleteBookmark(t),EverReaderJS.Notify("Bookmark deleted"))},error:function(){EverReaderJS.Notify("There was a problem deleting your bookmark","danger")}}),r.stopPropagation(),e("#koContextMenu").remove(),!1}function i(){var r=e(document).height(),t=e(window).height(),a=e(window).scrollTop();setTimeout(function(){var n=e(document).height(),d=e(window).height(),i=e(window).scrollTop();if(n==r&&d==t&&i==a&&i>l){var c=a/(r-t)*100;o||e.ajax("/api/bookmarks/"+noteGuid,{method:"PUT",data:{percentageRead:c},success:function(){l=a},error:function(){}})}n==r&&d==t&&i==a&&l>i&&0==u&&(u=1,setTimeout(function(){l=0,u=0},4e3))},700),c.readerViewModel.documentScrollPercent(a/(r-t)*100)}var c={readerViewModel:null},l=0,u=0;return c.calculateDocumentReadPosition=r,c.getSelection=a,c.navigateToPosition=t,c.addBookmark=n,c.deleteBookmark=d,c.scrollHandler=i,c}($,readerInDummyMode);$(document).ready(function(){$("#addBookmark").click(reader.addBookmark),$(window).scroll(null,reader.scrollHandler),reader.readerViewModel=function(e){function o(){return r(d)}function r(e){return(ko.isObservable(e)?e():e).toFixed(2)+"%"}function t(e,o,t){for(var a=0==n().length?0:n().length,d=0;d<n().length;d++)if(n()[d].percentageRead>o){a=d;break}n().splice(a,0,{id:e,action:function(){reader.navigateToPosition(o)},text:"["+r(o)+"] "+t+"&nbsp;<span class='glyphicon glyphicon-remove pull-right' onclick='return reader.deleteBookmark(event, "+e+");' style='top: 3px'></span>",percentageRead:o})}function a(e){for(var o=0;o<n().length;o++)if(n()[o].id==e){n().splice(o,1);break}}var n=ko.observableArray([]),d=ko.observable(0),i=[{text:"Citation",action:function(){var o=e+" ("+d().toFixed(2)+"%)";EverReaderJS.CopyToClipboard(o),EverReaderJS.Notify("Citation copied to clipboard")}},{text:"URL permalink",action:function(){var e=window.location.toString()+"#"+d().toFixed(2);EverReaderJS.CopyToClipboard(e),EverReaderJS.Notify("Permalink URL copied to clipboard")}}];return{bookmarks:n,copyMenu:i,addBookmark:t,deleteBookmark:a,documentScrollPercent:d,documentScrollPercentFormatted:o}}("undefined"==typeof documentTitle?"Untitled Note":documentTitle),ko.applyBindings(reader.readerViewModel),reader.navigateToPosition(percentageRead),readerInDummyMode||$.ajax("/api/bookmarks/"+noteGuid,{method:"GET",data:{},success:function(e){e.forEach(function(e){reader.readerViewModel.addBookmark(e.Id,e.PercentageRead,e.BookmarkTitle)})},error:function(){}})});var EverReaderJS=function(e){var o={};return o.Notify=function(o,r,t){e.notify({message:o},{type:r||"success",placement:{from:"bottom",align:"center"},delay:t||2500,offset:{y:50},z_index:1e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})},o.CopyToClipboard=function(o){var r=e("<input>");e("body").append(r),r.val(o).select(),document.execCommand("copy"),r.remove()},o}(jQuery);