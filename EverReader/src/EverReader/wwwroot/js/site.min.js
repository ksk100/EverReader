"use strict";function everReaderNotify(e,o){$.notify({message:e},{type:o||"success",placement:{from:"bottom",align:"center"},delay:2500,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}var lastSavedScrollTop=0,lastSavedScrollTopResetTimerSet=0,reader=function(e){function o(){var o=e(document).height(),r=e(window).height(),t=e(window).scrollTop();return t/(o-r)*100}function r(o){var r=e(document).height(),t=e(window).height(),a=o/100*(r-t);e(window).scrollTop(a)}function t(){var e=window.getSelection().toString();""!=e&&(c=e)}function a(){return c}function n(){var o=reader.calculateDocumentReadPosition(),r=reader.getSelection()||"[ untitled ]";return r.length>30&&(r=r.slice(0,r.indexOf(" ",30)+1)+"..."),e.ajax("/api/bookmarks/"+noteGuid,{method:"POST",data:{percentageRead:o,bookmarkTitle:r},success:function(e){d.readerViewModel.addBookmark(e.id,o,r),everReaderNotify("Bookmark added")},error:function(){}}),!1}function i(o,r){return e.ajax("/api/bookmarks/"+noteGuid,{method:"DELETE",data:{id:r},success:function(e){e.error?everReaderNotify("There was a problem deleting your bookmark","danger"):(d.readerViewModel.deleteBookmark(r),everReaderNotify("Bookmark deleted"))},error:function(){everReaderNotify("There was a problem deleting your bookmark","danger")}}),o.stopPropagation(),e("#koContextMenu").remove(),!1}var d={readerViewModel:null},c="";return d.calculateDocumentReadPosition=o,d.getSelection=a,d.navigateToPosition=r,d.saveSelection=t,d.addBookmark=n,d.deleteBookmark=i,d}($);$(document).ready(function(){$("body").click(reader.saveSelection),$("#addBookmark").click(reader.addBookmark),$(window).scroll(null,function(){var e=$(document).height(),o=$(window).height(),r=$(window).scrollTop();setTimeout(function(){var t=$(document).height(),a=$(window).height(),n=$(window).scrollTop();if(t==e&&a==o&&n==r&&n>lastSavedScrollTop){var i=r/(e-o)*100;$.ajax("/api/bookmarks/"+noteGuid,{method:"PUT",data:{percentageRead:i},success:function(){lastSavedScrollTop=r},error:function(){}})}t==e&&a==o&&n==r&&lastSavedScrollTop>n&&0==lastSavedScrollTopResetTimerSet&&(lastSavedScrollTopResetTimerSet=1,setTimeout(function(){lastSavedScrollTop=0,lastSavedScrollTopResetTimerSet=0},4e3))},700);var t=r/(e-o)*100;$("#positionReport").text(t.toPrecision(4)+"%")}),reader.navigateToPosition(percentageRead),reader.readerViewModel=function(){function e(e){return e.toPrecision(4)+"%"}function o(o,r,a){for(var n=0==t().length?0:t().length,i=0;i<t().length;i++)if(t()[i].percentageRead>r){n=i;break}t().splice(n,0,{id:o,action:function(){reader.navigateToPosition(r)},text:"["+e(r)+"] "+a+"&nbsp;<span class='glyphicon glyphicon-remove pull-right' onclick='return reader.deleteBookmark(event, "+o+");' style='top: 3px'></span>",percentageRead:r})}function r(e){for(var o=0;o<t().length;o++)if(t()[o].id==e){t().splice(o,1);break}}var t=ko.observableArray([]);return{bookmarks:t,addBookmark:o,deleteBookmark:r}}(),ko.applyBindings(reader.readerViewModel),$.ajax("/api/bookmarks/"+noteGuid,{method:"GET",data:{},success:function(e){e.forEach(function(e){reader.readerViewModel.addBookmark(e.Id,e.PercentageRead,e.BookmarkTitle)})},error:function(){}})});