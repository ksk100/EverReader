"use strict";function everReaderNotify(e,o,r){$.notify({message:e},{type:o||"success",placement:{from:"bottom",align:"center"},delay:r||2500,offset:{y:50},z_index:1e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}var reader=function(e,o){function r(){var o=e(document).height(),r=e(window).height(),a=e(window).scrollTop();return a/(o-r)*100}function a(o){reader.documentScrollPercent=o;var r=e(document).height(),a=e(window).height(),t=o/100*(r-a);e(window).scrollTop(t),c.readerViewModel.documentScrollPercent(o)}function t(){return window.getSelection().toString()}function n(){var r=c.calculateDocumentReadPosition(),a=c.getSelection()||"[ untitled ]";return a.length>30&&(a=a.slice(0,(a.indexOf(" ",30)>-1?a.indexOf(" ",30):a.lastIndexOf(" ")>-1?a.lastIndexOf(" "):30)+1)+"..."),o?(c.readerViewModel.addBookmark(reader.readerViewModel.bookmarks().length,r,a),everReaderNotify("Bookmark added")):e.ajax("/api/bookmarks/"+noteGuid,{method:"POST",data:{percentageRead:r,bookmarkTitle:a},success:function(e){c.readerViewModel.addBookmark(e.id,r,a),everReaderNotify("Bookmark added")},error:function(){}}),!1}function d(r,a){return o?(c.readerViewModel.deleteBookmark(a),everReaderNotify("Bookmark deleted")):e.ajax("/api/bookmarks/"+noteGuid,{method:"DELETE",data:{id:a},success:function(e){e.error?everReaderNotify("There was a problem deleting your bookmark","danger"):(c.readerViewModel.deleteBookmark(a),everReaderNotify("Bookmark deleted"))},error:function(){everReaderNotify("There was a problem deleting your bookmark","danger")}}),r.stopPropagation(),e("#koContextMenu").remove(),!1}function i(){var r=e(document).height(),a=e(window).height(),t=e(window).scrollTop();setTimeout(function(){var n=e(document).height(),d=e(window).height(),i=e(window).scrollTop();if(n==r&&d==a&&i==t&&i>l){var c=t/(r-a)*100;o||e.ajax("/api/bookmarks/"+noteGuid,{method:"PUT",data:{percentageRead:c},success:function(){l=t},error:function(){}})}n==r&&d==a&&i==t&&l>i&&0==u&&(u=1,setTimeout(function(){l=0,u=0},4e3))},700),c.readerViewModel.documentScrollPercent(t/(r-a)*100)}var c={readerViewModel:null},l=0,u=0;return c.calculateDocumentReadPosition=r,c.getSelection=t,c.navigateToPosition=a,c.addBookmark=n,c.deleteBookmark=d,c.scrollHandler=i,c}($,readerInDummyMode);$(document).ready(function(){$("#addBookmark").click(reader.addBookmark),$(window).scroll(null,reader.scrollHandler),reader.readerViewModel=function(){function e(){return o(n)}function o(e){return(ko.isObservable(e)?e():e).toFixed(2)+"%"}function r(e,r,a){for(var n=0==t().length?0:t().length,d=0;d<t().length;d++)if(t()[d].percentageRead>r){n=d;break}t().splice(n,0,{id:e,action:function(){reader.navigateToPosition(r)},text:"["+o(r)+"] "+a+"&nbsp;<span class='glyphicon glyphicon-remove pull-right' onclick='return reader.deleteBookmark(event, "+e+");' style='top: 3px'></span>",percentageRead:r})}function a(e){for(var o=0;o<t().length;o++)if(t()[o].id==e){t().splice(o,1);break}}var t=ko.observableArray([]),n=ko.observable(0);return{bookmarks:t,addBookmark:r,deleteBookmark:a,documentScrollPercent:n,documentScrollPercentFormatted:e}}(),ko.applyBindings(reader.readerViewModel),reader.navigateToPosition(percentageRead),readerInDummyMode||$.ajax("/api/bookmarks/"+noteGuid,{method:"GET",data:{},success:function(e){e.forEach(function(e){reader.readerViewModel.addBookmark(e.Id,e.PercentageRead,e.BookmarkTitle)})},error:function(){}})});