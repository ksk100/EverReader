"use strict";function everReaderNotify(e){$.notify({message:e},{type:"success",placement:{from:"bottom",align:"center"},delay:2500,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}var lastSavedScrollTop=0,lastSavedScrollTopResetTimerSet=0,reader=function(e){function o(){var o=e(document).height(),t=e(window).height(),a=e(window).scrollTop();return a/(o-t)*100}function t(o){var t=e(document).height(),a=e(window).height(),r=o/100*(t-a);e(window).scrollTop(r)}function a(){var e=window.getSelection().toString();""!=e&&(d=e)}function r(){return d}function n(){var o=reader.calculateDocumentReadPosition(),t=reader.getSelection()||"[ untitled ]";return t.length>30&&(t=t.slice(0,t.indexOf(" ",30)+1)+"..."),e.ajax("/api/bookmarks/"+noteGuid,{method:"POST",data:{percentageRead:o,bookmarkTitle:t},success:function(){i.readerViewModel.addBookmark(o,t),everReaderNotify("Bookmark successfully added")},error:function(){}}),!1}var i={readerViewModel:null},d="";return i.calculateDocumentReadPosition=o,i.getSelection=r,i.navigateToPosition=t,i.saveSelection=a,i.addBookmark=n,i}($);$(document).ready(function(){$("body").click(reader.saveSelection),$("#addBookmark").click(reader.addBookmark),$(window).scroll(null,function(){var e=$(document).height(),o=$(window).height(),t=$(window).scrollTop();setTimeout(function(){var a=$(document).height(),r=$(window).height(),n=$(window).scrollTop();if(a==e&&r==o&&n==t&&n>lastSavedScrollTop){var i=t/(e-o)*100;$.ajax("/api/bookmarks/"+noteGuid,{method:"PUT",data:{percentageRead:i},success:function(){lastSavedScrollTop=t},error:function(){}})}a==e&&r==o&&n==t&&lastSavedScrollTop>n&&0==lastSavedScrollTopResetTimerSet&&(lastSavedScrollTopResetTimerSet=1,setTimeout(function(){lastSavedScrollTop=0,lastSavedScrollTopResetTimerSet=0},4e3))},700);var a=t/(e-o)*100;$("#positionReport").text(a.toPrecision(4)+"%")}),reader.navigateToPosition(percentageRead),reader.readerViewModel=function(){function e(e){return e.toPrecision(4)+"%"}function o(o,a){for(var r=0==t().length?0:t().length,n=0;n<t().length;n++)if(t()[n].percentageRead>o){r=n;break}t().splice(r,0,{action:function(){reader.navigateToPosition(o)},text:"["+e(o)+"] "+a,percentageRead:o})}var t=ko.observableArray([]);return{bookmarks:t,addBookmark:o}}(),ko.applyBindings(reader.readerViewModel),$.ajax("/api/bookmarks/"+noteGuid,{method:"GET",data:{},success:function(e){e.forEach(function(e){reader.readerViewModel.addBookmark(e.PercentageRead,e.BookmarkTitle)})},error:function(){}})});